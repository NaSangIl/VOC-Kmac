<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.kmac.statistics.mapper.StatisticsMapper">

    <!-- 기간별 VOC 현황 조회 -->
    <select id="getVocStatusByPeriod" resultType="kr.co.kmac.statistics.dto.StatisticsDto$Info">
            SELECT A.periodType    AS "periodType"
                 , A.NOW_ALL_CNT   AS "totalCnt"
                 , CASE WHEN A.BF_ALL_CNT > 0
                        THEN ( ( A.NOW_ALL_CNT - A.BF_ALL_CNT ) / A.BF_ALL_CNT ) * 100
                        WHEN A.NOW_ALL_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "totalYoyCnt"
                   <!-- 불만 -->  
                 , A.NOW_01_CNT AS "complaintCnt"
                 , CASE WHEN NOW_ALL_CNT > 0
                        THEN (NOW_01_CNT/NOW_ALL_CNT) * 100 
                        ELSE 0
                   END AS "complaintRate"
                 , CASE WHEN BF_01_CNT > 0
                        THEN ( ( NOW_01_CNT - BF_01_CNT ) / BF_01_CNT ) * 100
                        WHEN NOW_01_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "complaintYoyCnt" 
                   <!-- 칭찬 -->
                 , A.NOW_02_CNT AS "complimentCnt"
                 , CASE WHEN NOW_ALL_CNT > 0
                        THEN (NOW_02_CNT/NOW_ALL_CNT) * 100 
                        ELSE 0
                   END AS "complimentRate"
                 , CASE WHEN BF_02_CNT > 0
                        THEN ( ( NOW_02_CNT - BF_02_CNT ) / BF_02_CNT ) * 100
                        WHEN NOW_02_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "complimentYoyCnt"       
                   <!-- 제안 -->                
                 , A.NOW_03_CNT AS "suggestionCnt"   
                 , CASE WHEN NOW_ALL_CNT > 0
                        THEN (NOW_03_CNT/NOW_ALL_CNT) * 100 
                        ELSE 0
                   END AS "suggestionRate"
                 , CASE WHEN BF_03_CNT > 0
                        THEN ( ( NOW_03_CNT - BF_03_CNT ) / BF_03_CNT ) * 100
                        WHEN NOW_03_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "suggestionYoyCnt"       
                   <!-- 문의 -->
                 , A.NOW_04_CNT AS "inquiryCnt"  
                 , CASE WHEN NOW_ALL_CNT > 0
                        THEN (NOW_04_CNT/NOW_ALL_CNT) * 100 
                        ELSE 0
                   END AS "inquiryRate"
                 , CASE WHEN BF_04_CNT > 0
                        THEN ( ( NOW_04_CNT - BF_04_CNT ) / BF_04_CNT ) * 100
                        WHEN NOW_04_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "inquiryYoyCnt"          
              FROM (
                        SELECT A.periodType
                             , SUM(A.NOW_ALL_CNT) AS NOW_ALL_CNT
                             , SUM(A.BF_ALL_CNT) AS BF_ALL_CNT       
                             , SUM(A.NOW_01_CNT) AS NOW_01_CNT
                             , SUM(A.BF_01_CNT) AS BF_01_CNT
                             , SUM(A.NOW_02_CNT) AS NOW_02_CNT
                             , SUM(A.BF_02_CNT) AS BF_02_CNT
                             , SUM(A.NOW_03_CNT) AS NOW_03_CNT
                             , SUM(A.BF_03_CNT) AS BF_03_CNT
                             , SUM(A.NOW_04_CNT) AS NOW_04_CNT
                             , SUM(A.BF_04_CNT) AS BF_04_CNT
                          FROM (
                                    SELECT 
                                          <if test='"Y".equals(periodType)'>      
                                                DATE_FORMAT(B.REG_DT, '%Y') AS "periodType"
                                          </if>                        
                                          <if test='"M".equals(periodType)'>      
                                                DATE_FORMAT(B.REG_DT, '%Y-%m') AS "periodType"
                                          </if>                        
                                          <if test='"D".equals(periodType)'>      
                                                DATE_FORMAT(B.REG_DT, '%Y-%m-%d') AS "periodType"
                                          </if>                                            
                                         , 1 AS NOW_ALL_CNT
                                         , IFNULL((SELECT COUNT(1) 
                                                     FROM TB_VOC_MST SUB
                                                    WHERE SUB.DEL_YN = 'N'
                                                      AND SUB.REG_DT <![CDATA[ > ]]> ADDDATE(date_add(DATE_FORMAT(B.REG_DT, '%Y-%m-%d'), interval -1 YEAR), -1)
                                                      AND SUB.REG_DT <![CDATA[ < ]]> ADDDATE(date_add(DATE_FORMAT(B.REG_DT, '%Y-%m-%d'), interval -1 YEAR), 1) 
                                                      AND SUB.COMPANY_CD = B.COMPANY_CD
                                           ),0) AS BF_ALL_CNT 
                                         , CASE WHEN B.VOC_CASE_CD = '01' 
                                                THEN 1 
                                                ELSE 0 
                                           END AS NOW_01_CNT
                                         , IFNULL((SELECT COUNT(1) 
                                                     FROM TB_VOC_MST SUB
                                                    WHERE SUB.DEL_YN = 'N'
                                                      AND SUB.REG_DT <![CDATA[ > ]]> ADDDATE(date_add(DATE_FORMAT(B.REG_DT, '%Y-%m-%d'), interval -1 YEAR), -1)
                                                      AND SUB.REG_DT <![CDATA[ < ]]> ADDDATE(date_add(DATE_FORMAT(B.REG_DT, '%Y-%m-%d'), interval -1 YEAR), 1)  
                                                      AND SUB.COMPANY_CD = B.COMPANY_CD
                                                      AND SUB.VOC_CASE_CD = '01'
                                           ),0) AS BF_01_CNT      
                                         , CASE WHEN B.VOC_CASE_CD = '02' 
                                                THEN 1 
                                                ELSE 0 
                                           END AS NOW_02_CNT
                                         , IFNULL((SELECT COUNT(1) 
                                                     FROM TB_VOC_MST SUB
                                                    WHERE SUB.DEL_YN = 'N'
                                                      AND SUB.REG_DT <![CDATA[ > ]]> ADDDATE(date_add(DATE_FORMAT(B.REG_DT, '%Y-%m-%d'), interval -1 YEAR), -1)
                                                      AND SUB.REG_DT <![CDATA[ < ]]> ADDDATE(date_add(DATE_FORMAT(B.REG_DT, '%Y-%m-%d'), interval -1 YEAR), 1) 
                                                      AND SUB.COMPANY_CD = B.COMPANY_CD
                                                      AND SUB.VOC_CASE_CD = '02'
                                           ),0) AS BF_02_CNT      
                                         , CASE WHEN B.VOC_CASE_CD = '03' 
                                                THEN 1 
                                                ELSE 0 
                                           END AS NOW_03_CNT
                                         , IFNULL((SELECT COUNT(1) 
                                                     FROM TB_VOC_MST SUB
                                                    WHERE SUB.DEL_YN = 'N'
                                                      AND SUB.REG_DT <![CDATA[ > ]]> ADDDATE(date_add(DATE_FORMAT(B.REG_DT, '%Y-%m-%d'), interval -1 YEAR), -1)
                                                      AND SUB.REG_DT <![CDATA[ < ]]> ADDDATE(date_add(DATE_FORMAT(B.REG_DT, '%Y-%m-%d'), interval -1 YEAR), 1) 
                                                      AND SUB.COMPANY_CD = B.COMPANY_CD
                                                      AND SUB.VOC_CASE_CD = '03'
                                           ),0) AS BF_03_CNT    
                                         , CASE WHEN B.VOC_CASE_CD = '04' 
                                                THEN 1 
                                                ELSE 0 
                                           END AS NOW_04_CNT
                                         , IFNULL((SELECT COUNT(1)
                                                     FROM TB_VOC_MST SUB
                                                    WHERE SUB.DEL_YN = 'N'
                                                      AND SUB.REG_DT <![CDATA[ > ]]> ADDDATE(date_add(DATE_FORMAT(B.REG_DT, '%Y-%m-%d'), interval -1 YEAR), -1)
                                                      AND SUB.REG_DT <![CDATA[ < ]]> ADDDATE(date_add(DATE_FORMAT(B.REG_DT, '%Y-%m-%d'), interval -1 YEAR), 1)                  
                                                      AND SUB.COMPANY_CD = B.COMPANY_CD
                                                      AND SUB.VOC_CASE_CD = '04'
                                           ),0) AS BF_04_CNT    
                                      FROM TB_VOC_MST B
                                     WHERE 1=1
                                       AND B.DEL_YN  = 'N'
                                        <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(regDtStart)">AND B.reg_dt <![CDATA[ > ]]> ADDDATE(#{regDtStart}, -1) </if>
                                        <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(regDtEnd)">AND B.reg_dt <![CDATA[ < ]]> ADDDATE(#{regDtEnd},1) </if>   
                                        
                                        <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(companyCd)"> AND B.company_cd = #{companyCd} </if>
                                        <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd1)">AND B.voc_type_cd1 = #{vocTypeCd1} </if>
                                        <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd2)">AND B.voc_type_cd2 = #{vocTypeCd2} </if>
                                        <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd3)">AND B.voc_type_cd3 = #{vocTypeCd3} </if>
                                        <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(rcptChnnCd)">AND B.rcpt_chnn_cd = #{rcptChnnCd} </if>                                     
                            ) A
                        GROUP BY A.periodType
        ) A
    </select>

    <!-- 유형별 VOC 현황 조회 -->
    <select id="getVocStatusByVoctype" resultType="kr.co.kmac.statistics.dto.StatisticsDto$Info">
		
			SELECT A.LEV1_CUSTOM_CD 	AS "vocTypeCd1"
				 , A.LEV1_CUSTOM_NM 	AS "vocTypeNm1"
				 <if test='"Y".equals(vocTypeCd2Yn)'>    
				 , A.LEV2_CUSTOM_CD		AS "vocTypeCd2"
				 , A.LEV2_CUSTOM_NM 	AS "vocTypeNm2"
				 </if>
				 <if test='"Y".equals(vocTypeCd3Yn)'>    
				 , A.LEV3_CUSTOM_CD		AS "vocTypeCd3"
				 , A.LEV3_CUSTOM_NM		AS "vocTypeNm3"
				 </if> 
				 , A.NOW_ALL_CNT   AS "totalCnt"
				 , CASE WHEN A.BF_ALL_CNT > 0
				        THEN ( ( A.NOW_ALL_CNT - A.BF_ALL_CNT ) / A.BF_ALL_CNT ) * 100
				 		WHEN A.NOW_ALL_CNT > 0
				 		THEN 100
				 		ELSE 0
				   END AS "totalYoyCnt"
				   <!-- 불만 -->	
				 , A.NOW_01_CNT AS "complaintCnt"
				 , CASE WHEN NOW_ALL_CNT > 0
				        THEN (NOW_01_CNT/NOW_ALL_CNT) * 100 
				        ELSE 0
				   END AS "complaintRate"
				 , CASE WHEN BF_01_CNT > 0
				        THEN ( ( NOW_01_CNT - BF_01_CNT ) / BF_01_CNT ) * 100
				 		WHEN NOW_01_CNT > 0
				 		THEN 100
				 		ELSE 0
				   END AS "complaintYoyCnt"	
				   <!-- 칭찬 -->
				 , A.NOW_02_CNT AS "complimentCnt"
				 , CASE WHEN NOW_ALL_CNT > 0
				        THEN (NOW_02_CNT/NOW_ALL_CNT) * 100 
				        ELSE 0
				   END AS "complimentRate"
				 , CASE WHEN BF_02_CNT > 0
				        THEN ( ( NOW_02_CNT - BF_02_CNT ) / BF_02_CNT ) * 100
				 		WHEN NOW_02_CNT > 0
				 		THEN 100
				 		ELSE 0
				   END AS "complimentYoyCnt"	   
				   <!-- 제안 -->				  
				 , A.NOW_03_CNT AS "suggestionCnt"   
				 , CASE WHEN NOW_ALL_CNT > 0
				        THEN (NOW_03_CNT/NOW_ALL_CNT) * 100 
				        ELSE 0
				   END AS "suggestionRate"
				 , CASE WHEN BF_03_CNT > 0
				        THEN ( ( NOW_03_CNT - BF_03_CNT ) / BF_03_CNT ) * 100
				 		WHEN NOW_03_CNT > 0
				 		THEN 100
				 		ELSE 0
				   END AS "suggestionYoyCnt"	   
				   <!-- 문의 -->
				 , A.NOW_04_CNT AS "inquiryCnt"  
				 , CASE WHEN NOW_ALL_CNT > 0
				        THEN (NOW_04_CNT/NOW_ALL_CNT) * 100 
				        ELSE 0
				   END AS "inquiryRate"
				 , CASE WHEN BF_04_CNT > 0
				        THEN ( ( NOW_04_CNT - BF_04_CNT ) / BF_04_CNT ) * 100
				 		WHEN NOW_04_CNT > 0
				 		THEN 100
				 		ELSE 0
				   END AS "inquiryYoyCnt"		   
			  FROM (
					SELECT A.LEV1_CUSTOM_CD
						 , A.LEV1_CUSTOM_NM
					     <if test="@org.apache.commons.lang3.ObjectUtils@isEmpty(vocTypeCd2Yn) and @org.apache.commons.lang3.ObjectUtils@isEmpty(vocTypeCd3Yn)">
						 , SUM(B.NOW_ALL_CNT) AS NOW_ALL_CNT
				 		 , SUM(C.BF_ALL_CNT) AS BF_ALL_CNT 
						 </if>
						 <if test='"Y".equals(vocTypeCd2Yn)'>
						     <if test="@org.apache.commons.lang3.ObjectUtils@isEmpty(vocTypeCd3Yn)">
								 , A.LEV2_CUSTOM_CD
								 , A.LEV2_CUSTOM_NM
								 , SUM(B.NOW_ALL_CNT) AS NOW_ALL_CNT
						 		 , SUM(C.BF_ALL_CNT) AS BF_ALL_CNT
							 </if>
						 
						 	 <if test='"Y".equals(vocTypeCd3Yn)'>
								 , A.LEV2_CUSTOM_CD
								 , A.LEV2_CUSTOM_NM
								 , A.LEV3_CUSTOM_CD
								 , A.LEV3_CUSTOM_NM
								 , SUM(B.NOW_ALL_CNT) AS NOW_ALL_CNT
						 		 , SUM(C.BF_ALL_CNT) AS BF_ALL_CNT
							 </if>
						 </if>
						 , SUM(NOW_01_CNT) AS NOW_01_CNT
						 , SUM(BF_01_CNT) AS BF_01_CNT 
						 , SUM(NOW_02_CNT) AS NOW_02_CNT
						 , SUM(BF_02_CNT) AS BF_02_CNT 
						 , SUM(NOW_03_CNT) AS NOW_03_CNT
						 , SUM(BF_03_CNT) AS BF_03_CNT 
						 , SUM(NOW_04_CNT) AS NOW_04_CNT
						 , SUM(BF_04_CNT) AS BF_04_CNT 
					  FROM (
							SELECT LEV1.CUSTOM_CD AS "LEV1_CUSTOM_CD"
							     , LEV1.CUSTOM_NM AS "LEV1_CUSTOM_NM"
							     <if test='"Y".equals(vocTypeCd2Yn)'>   
							     , LEV2.CUSTOM_CD AS "LEV2_CUSTOM_CD"
							     , LEV2.CUSTOM_NM AS "LEV2_CUSTOM_NM"
							     </if>
							     <if test='"Y".equals(vocTypeCd3Yn)'>   
							     , LEV3.CUSTOM_CD AS "LEV3_CUSTOM_CD"
							     , LEV3.CUSTOM_NM AS "LEV3_CUSTOM_NM"
							     </if>
							  FROM (
									SELECT A.CUSTOM_CD 
								         , A.CUSTOM_NM
								         , A.CUSTOM_LEVEL
								         , A.UPPER_CUSTOM_CD 
								         , A.DISP_ORDER
									  FROM TB_COMPANY_CUSTOM_CODE A
									       INNER JOIN TB_COMPANY B
									               ON A.COMPANY_SEQ = B.COMPANY_SEQ
									              AND B.COMPANY_CD = #{companyCd}
									 WHERE 1=1
									   AND A.USE_YN = 'Y'
									   AND A.CUSTOM_TYPE = 'VOC_TYPE'
									   AND A.CUSTOM_LEVEL = 1
									) LEV1
									<if test='"Y".equals(vocTypeCd2Yn)'>    
									LEFT OUTER JOIN (
														SELECT A.CUSTOM_CD 
													         , A.CUSTOM_NM
													         , A.CUSTOM_LEVEL
													         , A.UPPER_CUSTOM_CD 
													         , A.DISP_ORDER
														  FROM TB_COMPANY_CUSTOM_CODE A
														       INNER JOIN TB_COMPANY B
														               ON A.COMPANY_SEQ = B.COMPANY_SEQ
														              AND B.COMPANY_CD = #{companyCd}
														 WHERE 1=1
														   AND A.USE_YN = 'Y'
														   AND A.CUSTOM_TYPE = 'VOC_TYPE'
														   AND A.CUSTOM_LEVEL = 2
													 ) LEV2
												 ON LEV1.CUSTOM_CD = LEV2.UPPER_CUSTOM_CD
									</if>
									<if test='"Y".equals(vocTypeCd3Yn)'>    			 
									LEFT OUTER JOIN (
														SELECT A.CUSTOM_CD 
													         , A.CUSTOM_NM
													         , A.CUSTOM_LEVEL
													         , A.UPPER_CUSTOM_CD 
													         , A.DISP_ORDER
														  FROM TB_COMPANY_CUSTOM_CODE A
														       INNER JOIN TB_COMPANY B
														               ON A.COMPANY_SEQ = B.COMPANY_SEQ
														              AND B.COMPANY_CD = #{companyCd}
														 WHERE 1=1
														   AND A.USE_YN = 'Y'
														   AND A.CUSTOM_TYPE = 'VOC_TYPE'
														   AND A.CUSTOM_LEVEL = 3
													 ) LEV3
												 ON LEV2.CUSTOM_CD = LEV3.UPPER_CUSTOM_CD
									</if>
							WHERE 1=1
							
							<if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd1)">
  						      AND LEV1.CUSTOM_CD = #{vocTypeCd1}
						    </if>
							<if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd2)">
  						      AND LEV2.CUSTOM_CD = #{vocTypeCd2}
						    </if>
							<if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd3)">
  						      AND LEV3.CUSTOM_CD = #{vocTypeCd3}
						    </if>
						    
							ORDER BY LEV1.DISP_ORDER ASC
									<if test='"Y".equals(vocTypeCd2Yn)'>    
							       , LEV2.DISP_ORDER ASC
							       </if>
							       <if test='"Y".equals(vocTypeCd3Yn)'>    
							       , LEV3.DISP_ORDER ASC
							       </if>
							) A	
							LEFT OUTER JOIN (
							                      SELECT VOC_TYPE_CD1
							                           , VOC_TYPE_CD2
							                           , VOC_TYPE_CD3
							                           , VOC_CASE_CD
							                           , COUNT(1) AS NOW_ALL_CNT
							                           , CASE WHEN B.VOC_CASE_CD = '01' 
							                                  THEN SUM(1)
							                                  ELSE 0
							                             END AS NOW_01_CNT
							                           , CASE WHEN B.VOC_CASE_CD = '02' 
							                                  THEN SUM(1)
							                                  ELSE 0
							                             END AS NOW_02_CNT
							                           , CASE WHEN B.VOC_CASE_CD = '03' 
							                                  THEN SUM(1)
							                                  ELSE 0
							                             END AS NOW_03_CNT
							                           , CASE WHEN B.VOC_CASE_CD = '04' 
							                                  THEN SUM(1)
							                                  ELSE 0
							                             END AS NOW_04_CNT
							                        FROM TB_VOC_MST B
							                       WHERE 1=1
										             AND B.REG_DT <![CDATA[ > ]]> ADDDATE(#{regDtStart}, -1)
								                     AND B.REG_DT <![CDATA[ < ]]> ADDDATE(#{regDtEnd}, 1)
								                     AND B.COMPANY_CD = #{companyCd}
								                     AND B.DEL_YN = 'N'
								                    <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(rcptChnnCd)">
								                     AND B.RCPT_CHNN_CD = #{rcptChnnCd}
								                    </if>
								                   GROUP BY VOC_TYPE_CD1
								                          , VOC_TYPE_CD2
								                          , VOC_TYPE_CD3
								                          , VOC_CASE_CD 
						                   ) B 
									      ON A.LEV1_CUSTOM_CD = B.VOC_TYPE_CD1
								     <if test='"Y".equals(vocTypeCd2Yn)'>      						                 
								         AND A.LEV2_CUSTOM_CD = B.VOC_TYPE_CD2
								     </if>
								     <if test='"Y".equals(vocTypeCd3Yn)'>    
						                 AND A.LEV3_CUSTOM_CD = B.VOC_TYPE_CD3
                                     </if>									

					                    
							LEFT OUTER JOIN (
												  SELECT VOC_TYPE_CD1
							                           , VOC_TYPE_CD2
							                           , VOC_TYPE_CD3
							                           , VOC_CASE_CD
							                           , COUNT(1) AS BF_ALL_CNT
							                           , CASE WHEN C.VOC_CASE_CD = '01' 
							                                  THEN SUM(1)
							                                  ELSE 0
							                             END AS BF_01_CNT
							                           , CASE WHEN C.VOC_CASE_CD = '02' 
							                                  THEN SUM(1)
							                                  ELSE 0
							                             END AS BF_02_CNT
							                           , CASE WHEN C.VOC_CASE_CD = '03' 
							                                  THEN SUM(1)
							                                  ELSE 0
							                             END AS BF_03_CNT
							                           , CASE WHEN C.VOC_CASE_CD = '04' 
							                                  THEN SUM(1)
							                                  ELSE 0
							                             END AS BF_04_CNT
							                        FROM TB_VOC_MST C
							                       WHERE 1=1
											         AND C.REG_DT <![CDATA[ > ]]> ADDDATE(date_add(#{regDtStart}, interval -1 YEAR), -1)
									                 AND C.REG_DT <![CDATA[ < ]]> ADDDATE(date_add(#{regDtEnd}, interval -1 YEAR), 1)
									                 AND C.COMPANY_CD = #{companyCd}
									                 AND C.DEL_YN = 'N'
									             <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(rcptChnnCd)">
									                 AND C.RCPT_CHNN_CD = #{rcptChnnCd}
									             </if>          
								                   GROUP BY VOC_TYPE_CD1
								                          , VOC_TYPE_CD2
								                          , VOC_TYPE_CD3
								                          , VOC_CASE_CD									               
										  ) C
							             ON A.LEV1_CUSTOM_CD = C.VOC_TYPE_CD1
							        <if test='"Y".equals(vocTypeCd2Yn)'>     
								        AND A.LEV2_CUSTOM_CD = C.VOC_TYPE_CD2
								    </if>    
								    <if test='"Y".equals(vocTypeCd3Yn)'>  
						                AND A.LEV3_CUSTOM_CD = C.VOC_TYPE_CD3
						            </if>    

						GROUP BY A.LEV1_CUSTOM_CD
						       , A.LEV1_CUSTOM_NM
						     <if test='"Y".equals(vocTypeCd2Yn)'>       
						       , A.LEV2_CUSTOM_CD
						       , A.LEV2_CUSTOM_NM
						     </if>  
						     <if test='"Y".equals(vocTypeCd3Yn)'>    
						       , A.LEV3_CUSTOM_CD
						       , A.LEV3_CUSTOM_NM
						     </if>
					) A
    </select>

    <!-- 접수채널별 VOC 현황 조회 -->
    <select id="getVocStatusByChannel" resultType="kr.co.kmac.statistics.dto.StatisticsDto$Info">
		SELECT A.rcptChnnCd
		     , A.rcptChnnNm
		     , SUM(A.NOW_ALL_CNT)   AS "totalCnt"
		     , SUM(A.BF_ALL_CNT)
		     , CASE WHEN SUM(A.BF_ALL_CNT) > 0
		            THEN ( ( SUM(A.NOW_ALL_CNT) - SUM(A.BF_ALL_CNT) ) / SUM(A.BF_ALL_CNT) ) * 100
		            WHEN SUM(A.NOW_ALL_CNT) > 0
		            THEN 100
		            ELSE 0
		       END AS "totalYoyCnt"
		       /* 불만 */  
		     , SUM(A.NOW_01_CNT) AS "complaintCnt"
		     , CASE WHEN SUM(NOW_ALL_CNT) > 0
		            THEN (SUM(NOW_01_CNT)/SUM(NOW_ALL_CNT)) * 100 
		            ELSE 0
		       END AS "complaintRate"
		     , CASE WHEN SUM(BF_01_CNT) > 0
		            THEN ( ( SUM(NOW_01_CNT) - SUM(BF_01_CNT) ) / SUM(BF_01_CNT) ) * 100
		            WHEN SUM(NOW_01_CNT) > 0
		            THEN 100
		            ELSE 0
		       END AS "complaintYoyCnt" 
		       /* 칭찬 */
		     , SUM(A.NOW_02_CNT) AS "complimentCnt"
		     , CASE WHEN SUM(NOW_ALL_CNT) > 0
		            THEN (SUM(NOW_02_CNT)/SUM(NOW_ALL_CNT)) * 100 
		            ELSE 0
		       END AS "complimentRate"
		     , CASE WHEN SUM(BF_02_CNT) > 0
		            THEN ( ( SUM(NOW_02_CNT) - SUM(BF_02_CNT) ) / SUM(BF_02_CNT) ) * 100
		            WHEN SUM(NOW_02_CNT) > 0
		            THEN 100
		            ELSE 0
		       END AS "complimentYoyCnt"       
		       /* 제안 */                
		     , SUM(A.NOW_03_CNT) AS "suggestionCnt"   
		     , CASE WHEN SUM(NOW_ALL_CNT) > 0
		            THEN (SUM(NOW_03_CNT)/SUM(NOW_ALL_CNT)) * 100 
		            ELSE 0
		       END AS "suggestionRate"
		     , CASE WHEN SUM(BF_03_CNT) > 0
		            THEN ( ( SUM(NOW_03_CNT) - SUM(BF_03_CNT) ) / SUM(BF_03_CNT) ) * 100
		            WHEN SUM(NOW_03_CNT) > 0
		            THEN 100
		            ELSE 0
		       END AS "suggestionYoyCnt"       
		       /* 문의 */
		     , SUM(A.NOW_04_CNT) AS "inquiryCnt"  
		     , CASE WHEN SUM(NOW_ALL_CNT) > 0
		            THEN (SUM(NOW_04_CNT)/SUM(NOW_ALL_CNT)) * 100 
		            ELSE 0
		       END AS "inquiryRate"
		     , CASE WHEN SUM(BF_04_CNT) > 0
		            THEN ( ( SUM(NOW_04_CNT) - SUM(BF_04_CNT) ) / SUM(BF_04_CNT) ) * 100
		            WHEN SUM(NOW_04_CNT) > 0
		            THEN 100
		            ELSE 0
		       END AS "inquiryYoyCnt"   
		  FROM (        
		           SELECT A.RCPT_CHNN_CD    AS rcptChnnCd
		                , CD.CODE_NM        AS rcptChnnNm
		                , 1                 AS NOW_ALL_CNT
		                , (
		                    SELECT 1
		                      FROM TB_VOC_MST SUB
		                     WHERE DATEDIFF(SUB.REG_DT, ADDDATE(A.REG_DT,  interval -1 YEAR)) = 0 /* 작년 동월 동일 */
		                       AND SUB.RCPT_CHNN_CD = A.RCPT_CHNN_CD
		                       AND SUB.COMPANY_CD = #{companyCd}
		                       AND SUB.DEL_YN  = 'N'
		                  ) AS BF_ALL_CNT
		                , CASE WHEN A.VOC_CASE_CD = '01' 
		                       THEN 1
		                       ELSE 0 
		                  END AS NOW_01_CNT  
		                , (
		                    SELECT 1
		                      FROM TB_VOC_MST SUB
		                     WHERE DATEDIFF(SUB.REG_DT, ADDDATE(A.REG_DT,  interval -1 YEAR)) = 0 /* 작년 동월 동일 */
		                       AND SUB.RCPT_CHNN_CD = A.RCPT_CHNN_CD
		                       AND SUB.VOC_CASE_CD = '01'
		                       AND SUB.COMPANY_CD = #{companyCd}
		                       AND SUB.DEL_YN  = 'N'
		                  ) AS BF_01_CNT                  
		                , CASE WHEN A.VOC_CASE_CD = '02' 
		                       THEN 1
		                       ELSE 0 
		                  END AS NOW_02_CNT  
		                , (
		                    SELECT 1
		                      FROM TB_VOC_MST SUB
		                     WHERE DATEDIFF(SUB.REG_DT, ADDDATE(A.REG_DT,  interval -1 YEAR)) = 0 /* 작년 동월 동일 */
		                       AND SUB.RCPT_CHNN_CD = A.RCPT_CHNN_CD
		                       AND SUB.VOC_CASE_CD = '02'
		                       AND SUB.COMPANY_CD = #{companyCd}
		                       AND SUB.DEL_YN  = 'N'
		                  ) AS BF_02_CNT                  
		                , CASE WHEN A.VOC_CASE_CD = '03' 
		                       THEN 1
		                       ELSE 0 
		                  END AS NOW_03_CNT  
		                , (
		                    SELECT 1
		                      FROM TB_VOC_MST SUB
		                     WHERE DATEDIFF(SUB.REG_DT, ADDDATE(A.REG_DT,  interval -1 YEAR)) = 0 /* 작년 동월 동일 */
		                       AND SUB.RCPT_CHNN_CD = A.RCPT_CHNN_CD
		                       AND SUB.VOC_CASE_CD = '03'
		                       AND SUB.COMPANY_CD = #{companyCd}
		                       AND SUB.DEL_YN  = 'N'
		                  ) AS BF_03_CNT                  
		                , CASE WHEN A.VOC_CASE_CD = '04' 
		                       THEN 1
		                       ELSE 0 
		                  END AS NOW_04_CNT  
		                , (
		                    SELECT 1
		                      FROM TB_VOC_MST SUB
		                     WHERE DATEDIFF(SUB.REG_DT, ADDDATE(A.REG_DT,  interval -1 YEAR)) = 0 /* 작년 동월 동일 */
		                       AND SUB.RCPT_CHNN_CD = A.RCPT_CHNN_CD
		                       AND SUB.VOC_CASE_CD = '04'
		                       AND SUB.COMPANY_CD = #{companyCd}
		                       AND SUB.DEL_YN  = 'N'
		                  ) AS BF_04_CNT                  
		             FROM TB_VOC_MST A
		                  LEFT OUTER JOIN TB_SYS_CODE CD
		                               ON A.RCPT_CHNN_CD = CD.CODE
		                              AND CD.CODE_TYPE = 'RCPT_CHNN_CD'
		                              AND CD.USE_YN = 'Y'
		            WHERE 1=1
		              AND A.DEL_YN  = 'N'
		              AND A.COMPANY_CD = #{companyCd}
		              <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(regDtStart)">
		              AND A.REG_DT <![CDATA[ > ]]> ADDDATE(#{regDtStart}, -1)
		              </if>
		              <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(regDtEnd)">
		              AND A.REG_DT <![CDATA[ < ]]> ADDDATE(#{regDtEnd}, 1)
		              </if>
		              <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd1)">AND A.voc_type_cd1 = #{vocTypeCd1} </if>
				      <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd2)">AND A.voc_type_cd2 = #{vocTypeCd2} </if>
				      <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd3)">AND A.voc_type_cd3 = #{vocTypeCd3} </if>
				      <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(rcptChnnCd)">AND A.rcpt_chnn_cd = #{rcptChnnCd} </if>     
		                 
		    ) A                
		GROUP BY A.rcptChnnCd
		       , A.rcptChnnNm        
    </select>

    <!-- 처리유형별 VOC 현황 조회 -->
    <select id="getVocStatusByActtype" resultType="kr.co.kmac.statistics.dto.StatisticsDto$Info">
            SELECT A.LEV1_CUSTOM_CD     AS "vocActTypeCd1"
                 , A.LEV1_CUSTOM_NM     AS "vocActTypeNm1"
                 <if test='"Y".equals(vocActTypeCd2Yn)'>    
                 , A.LEV2_CUSTOM_CD     AS "vocActTypeCd2"
                 , A.LEV2_CUSTOM_NM     AS "vocActTypeNm2"
                 </if>
                 , A.NOW_ALL_CNT   AS "totalCnt"
                 , CASE WHEN A.BF_ALL_CNT > 0
                        THEN ( ( A.NOW_ALL_CNT - A.BF_ALL_CNT ) / A.BF_ALL_CNT ) * 100
                        WHEN A.NOW_ALL_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "totalYoyCnt"
                   <!-- 불만 -->  
                 , A.NOW_01_CNT AS "complaintCnt"
                 , CASE WHEN NOW_ALL_CNT > 0
                        THEN (NOW_01_CNT/NOW_ALL_CNT) * 100 
                        ELSE 0
                   END AS "complaintRate"
                 , CASE WHEN BF_01_CNT > 0
                        THEN ( ( NOW_01_CNT - BF_01_CNT ) / BF_01_CNT ) * 100
                        WHEN NOW_01_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "complaintYoyCnt" 
                   <!-- 칭찬 -->
                 , A.NOW_02_CNT AS "complimentCnt"
                 , CASE WHEN NOW_ALL_CNT > 0
                        THEN (NOW_02_CNT/NOW_ALL_CNT) * 100 
                        ELSE 0
                   END AS "complimentRate"
                 , CASE WHEN BF_02_CNT > 0
                        THEN ( ( NOW_02_CNT - BF_02_CNT ) / BF_02_CNT ) * 100
                        WHEN NOW_02_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "complimentYoyCnt"       
                   <!-- 제안 -->                
                 , A.NOW_03_CNT AS "suggestionCnt"   
                 , CASE WHEN NOW_ALL_CNT > 0
                        THEN (NOW_03_CNT/NOW_ALL_CNT) * 100 
                        ELSE 0
                   END AS "suggestionRate"
                 , CASE WHEN BF_03_CNT > 0
                        THEN ( ( NOW_03_CNT - BF_03_CNT ) / BF_03_CNT ) * 100
                        WHEN NOW_03_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "suggestionYoyCnt"       
                   <!-- 문의 -->
                 , A.NOW_04_CNT AS "inquiryCnt"  
                 , CASE WHEN NOW_ALL_CNT > 0
                        THEN (NOW_04_CNT/NOW_ALL_CNT) * 100 
                        ELSE 0
                   END AS "inquiryRate"
                 , CASE WHEN BF_04_CNT > 0
                        THEN ( ( NOW_04_CNT - BF_04_CNT ) / BF_04_CNT ) * 100
                        WHEN NOW_04_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "inquiryYoyCnt"          
              FROM (
                    SELECT A.LEV1_CUSTOM_CD
                         , A.LEV1_CUSTOM_NM
                         <if test="@org.apache.commons.lang3.ObjectUtils@isEmpty(vocActTypeCd2Yn)">
                         , SUM(B.NOW_ALL_CNT) AS NOW_ALL_CNT
                         , SUM(C.BF_ALL_CNT) AS BF_ALL_CNT
                         </if>
                         <if test='"Y".equals(vocActTypeCd2Yn)'>
                         , A.LEV2_CUSTOM_CD
                         , A.LEV2_CUSTOM_NM
                         , SUM(B.NOW_ALL_CNT) AS NOW_ALL_CNT
                         , SUM(C.BF_ALL_CNT) AS BF_ALL_CNT
                         </if>
                         , SUM(NOW_01_CNT) AS NOW_01_CNT
                         , SUM(BF_01_CNT) AS BF_01_CNT 
                         , SUM(NOW_02_CNT) AS NOW_02_CNT
                         , SUM(BF_02_CNT) AS BF_02_CNT 
                         , SUM(NOW_03_CNT) AS NOW_03_CNT
                         , SUM(BF_03_CNT) AS BF_03_CNT 
                         , SUM(NOW_04_CNT) AS NOW_04_CNT
                         , SUM(BF_04_CNT) AS BF_04_CNT 
                      FROM (
                            SELECT LEV1.CUSTOM_CD AS "LEV1_CUSTOM_CD"
                                 , LEV1.CUSTOM_NM AS "LEV1_CUSTOM_NM"
                                 <if test='"Y".equals(vocActTypeCd2Yn)'>   
                                 , LEV2.CUSTOM_CD AS "LEV2_CUSTOM_CD"
                                 , LEV2.CUSTOM_NM AS "LEV2_CUSTOM_NM"
                                 </if>
                              FROM (
                                    SELECT A.CUSTOM_CD 
                                         , A.CUSTOM_NM
                                         , A.CUSTOM_LEVEL
                                         , A.UPPER_CUSTOM_CD 
                                         , A.DISP_ORDER
                                      FROM TB_COMPANY_CUSTOM_CODE A
                                           INNER JOIN TB_COMPANY B
                                                   ON A.COMPANY_SEQ = B.COMPANY_SEQ
                                                  AND B.COMPANY_CD = #{companyCd}
                                     WHERE 1=1
                                       AND A.USE_YN = 'Y'
                                       AND A.CUSTOM_TYPE = 'VOC_ACT_TYPE'
                                       AND A.CUSTOM_LEVEL = 1
                                    ) LEV1
                                    <if test='"Y".equals(vocActTypeCd2Yn)'>    
                                    LEFT OUTER JOIN (
                                                        SELECT A.CUSTOM_CD 
                                                             , A.CUSTOM_NM
                                                             , A.CUSTOM_LEVEL
                                                             , A.UPPER_CUSTOM_CD 
                                                             , A.DISP_ORDER
                                                          FROM TB_COMPANY_CUSTOM_CODE A
                                                               INNER JOIN TB_COMPANY B
                                                                       ON A.COMPANY_SEQ = B.COMPANY_SEQ
                                                                      AND B.COMPANY_CD = #{companyCd}
                                                         WHERE 1=1
                                                           AND A.USE_YN = 'Y'
                                                           AND A.CUSTOM_TYPE = 'VOC_ACT_TYPE'
                                                           AND A.CUSTOM_LEVEL = 2
                                                     ) LEV2
                                                 ON LEV1.CUSTOM_CD = LEV2.UPPER_CUSTOM_CD
                                    </if>
                            WHERE 1=1
                            <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocActTypeCd1)">
                                AND LEV1.CUSTOM_CD = #{vocActTypeCd1} 
                            </if>
                            <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocActTypeCd2)">
                                AND LEV2.CUSTOM_CD = #{vocActTypeCd2} 
                            </if>

                            
                            ORDER BY LEV1.DISP_ORDER ASC
                                    <if test='"Y".equals(vocActTypeCd2Yn)'>    
                                   , LEV2.DISP_ORDER ASC
                                   </if>
                            ) A 
                            LEFT OUTER JOIN (
                                                  SELECT VOC_ACT_TYPE_CD1
                                                       , VOC_ACT_TYPE_CD2
                                                       , VOC_CASE_CD
                                                       , COUNT(1) AS NOW_ALL_CNT
                                                       , CASE WHEN B.VOC_CASE_CD = '01' 
                                                              THEN SUM(1)
                                                              ELSE 0
                                                         END AS NOW_01_CNT
                                                       , CASE WHEN B.VOC_CASE_CD = '02' 
                                                              THEN SUM(1)
                                                              ELSE 0
                                                         END AS NOW_02_CNT
                                                       , CASE WHEN B.VOC_CASE_CD = '03' 
                                                              THEN SUM(1)
                                                              ELSE 0
                                                         END AS NOW_03_CNT
                                                       , CASE WHEN B.VOC_CASE_CD = '04' 
                                                              THEN SUM(1)
                                                              ELSE 0
                                                         END AS NOW_04_CNT
                                                    FROM TB_VOC_MST B
                                                   WHERE 1=1
			                                         AND B.REG_DT <![CDATA[ > ]]> ADDDATE(#{regDtStart}, -1)
			                                         AND B.REG_DT <![CDATA[ < ]]> ADDDATE(#{regDtEnd}, 1)
			                                         AND B.COMPANY_CD = #{companyCd}
			                                         AND B.DEL_YN = 'N'
			                                         <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(rcptChnnCd)">
			                                             AND B.RCPT_CHNN_CD = #{rcptChnnCd}
			                                         </if>
			                                         <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd1)">
			                                             AND B.VOC_TYPE_CD1 = #{vocTypeCd1}
			                                         </if>
			                                         <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd2)">
			                                             AND B.VOC_TYPE_CD2 = #{vocTypeCd2}
			                                         </if>
			                                         <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd3)">
			                                             AND B.VOC_TYPE_CD3 = #{vocTypeCd3}
			                                         </if>
                                                   GROUP BY VOC_ACT_TYPE_CD1
                                                          , VOC_ACT_TYPE_CD2
                                                          , VOC_CASE_CD 
                                           ) B 
                                         ON A.LEV1_CUSTOM_CD = B.VOC_ACT_TYPE_CD1
                                    <if test='"Y".equals(vocActTypeCd2Yn)'>                                             
                                        AND A.LEV2_CUSTOM_CD = B.VOC_ACT_TYPE_CD2
                                    </if>
                            LEFT OUTER JOIN (
                                                  SELECT VOC_ACT_TYPE_CD1
                                                       , VOC_ACT_TYPE_CD2
                                                       , VOC_CASE_CD
                                                       , COUNT(1) AS BF_ALL_CNT
                                                       , CASE WHEN C.VOC_CASE_CD = '01' 
                                                              THEN SUM(1)
                                                              ELSE 0
                                                         END AS BF_01_CNT
                                                       , CASE WHEN C.VOC_CASE_CD = '02' 
                                                              THEN SUM(1)
                                                              ELSE 0
                                                         END AS BF_02_CNT
                                                       , CASE WHEN C.VOC_CASE_CD = '03' 
                                                              THEN SUM(1)
                                                              ELSE 0
                                                         END AS BF_03_CNT
                                                       , CASE WHEN C.VOC_CASE_CD = '04' 
                                                              THEN SUM(1)
                                                              ELSE 0
                                                         END AS BF_04_CNT
                                                    FROM TB_VOC_MST C
                                                   WHERE 1=1
			                                        AND C.REG_DT <![CDATA[ > ]]> ADDDATE(date_add(#{regDtStart}, interval -1 YEAR), -1)
			                                        AND C.REG_DT <![CDATA[ < ]]> ADDDATE(date_add(#{regDtEnd}, interval -1 YEAR), 1)
			                                        AND C.COMPANY_CD = #{companyCd}
			                                        AND C.DEL_YN = 'N'
			                                        <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(rcptChnnCd)">
			                                            AND C.RCPT_CHNN_CD = #{rcptChnnCd}
			                                        </if>            
			                                        <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd1)">
			                                            AND C.VOC_TYPE_CD1 = #{vocTypeCd1}
			                                        </if>
			                                        <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd2)">
			                                            AND C.VOC_TYPE_CD2 = #{vocTypeCd2}
			                                        </if>
			                                        <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd3)">
			                                            AND C.VOC_TYPE_CD3 = #{vocTypeCd3}
			                                        </if>                                   
                                                   GROUP BY VOC_ACT_TYPE_CD1
                                                          , VOC_ACT_TYPE_CD2
                                                          , VOC_CASE_CD                                                
                                          ) C
                                         ON A.LEV1_CUSTOM_CD = C.VOC_ACT_TYPE_CD1
                                        <if test='"Y".equals(vocActTypeCd2Yn)'>     
                                            AND A.LEV2_CUSTOM_CD = C.VOC_ACT_TYPE_CD2
                                        </if>    
         
                        GROUP BY A.LEV1_CUSTOM_CD
                               , A.LEV1_CUSTOM_NM
                             <if test='"Y".equals(vocActTypeCd2Yn)'>       
                               , A.LEV2_CUSTOM_CD
                               , A.LEV2_CUSTOM_NM
                             </if>  
                    ) A
    </select>

    <!-- 처리기간별 VOC 현황 조회 -->
    <select id="getVocStatusByActperiod" resultType="kr.co.kmac.statistics.dto.StatisticsDto$Info">
            SELECT A.LEV1_CUSTOM_CD     AS "periodType"
                 , A.LEV1_CUSTOM_NM     AS "actPeriod"
                 , A.NOW_ALL_CNT   AS "totalCnt"
                 , CASE WHEN A.BF_ALL_CNT > 0
                        THEN ( ( A.NOW_ALL_CNT - A.BF_ALL_CNT ) / A.BF_ALL_CNT ) * 100
                        WHEN A.NOW_ALL_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "totalYoyCnt"
                   <!-- 불만 -->  
                 , A.NOW_01_CNT AS "complaintCnt"
                 , CASE WHEN NOW_ALL_CNT > 0
                        THEN (NOW_01_CNT/NOW_ALL_CNT) * 100 
                        ELSE 0
                   END AS "complaintRate"
                 , CASE WHEN BF_01_CNT > 0
                        THEN ( ( NOW_01_CNT - BF_01_CNT ) / BF_01_CNT ) * 100
                        WHEN NOW_01_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "complaintYoyCnt" 
                   <!-- 칭찬 -->
                 , A.NOW_02_CNT AS "complimentCnt"
                 , CASE WHEN NOW_ALL_CNT > 0
                        THEN (NOW_02_CNT/NOW_ALL_CNT) * 100 
                        ELSE 0
                   END AS "complimentRate"
                 , CASE WHEN BF_02_CNT > 0
                        THEN ( ( NOW_02_CNT - BF_02_CNT ) / BF_02_CNT ) * 100
                        WHEN NOW_02_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "complimentYoyCnt"       
                   <!-- 제안 -->                
                 , A.NOW_03_CNT AS "suggestionCnt"   
                 , CASE WHEN NOW_ALL_CNT > 0
                        THEN (NOW_03_CNT/NOW_ALL_CNT) * 100 
                        ELSE 0
                   END AS "suggestionRate"
                 , CASE WHEN BF_03_CNT > 0
                        THEN ( ( NOW_03_CNT - BF_03_CNT ) / BF_03_CNT ) * 100
                        WHEN NOW_03_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "suggestionYoyCnt"       
                   <!-- 문의 -->
                 , A.NOW_04_CNT AS "inquiryCnt"  
                 , CASE WHEN NOW_ALL_CNT > 0
                        THEN (NOW_04_CNT/NOW_ALL_CNT) * 100 
                        ELSE 0
                   END AS "inquiryRate"
                 , CASE WHEN BF_04_CNT > 0
                        THEN ( ( NOW_04_CNT - BF_04_CNT ) / BF_04_CNT ) * 100
                        WHEN NOW_04_CNT > 0
                        THEN 100
                        ELSE 0
                   END AS "inquiryYoyCnt"          
              FROM (
                    SELECT A.LEV1_CUSTOM_CD
                         , A.LEV1_CUSTOM_NM
                         , COUNT(B.CNT) AS NOW_ALL_CNT
                         , COUNT(C.CNT) AS BF_ALL_CNT       
                         , CASE WHEN B.VOC_CASE_CD = '01' 
                                THEN SUM(1) 
                                ELSE 0 
                           END AS NOW_01_CNT
                         , CASE WHEN C.VOC_CASE_CD = '01' 
                                THEN SUM(1) 
                                ELSE 0 
                           END AS BF_01_CNT
                         , CASE WHEN B.VOC_CASE_CD = '02' 
                                THEN SUM(1) 
                                ELSE 0 
                           END AS NOW_02_CNT
                         , CASE WHEN C.VOC_CASE_CD = '02' 
                                THEN SUM(1) 
                                ELSE 0 
                           END AS BF_02_CNT
                         , CASE WHEN B.VOC_CASE_CD = '03' 
                                THEN SUM(1) 
                                ELSE 0 
                           END AS NOW_03_CNT
                         , CASE WHEN C.VOC_CASE_CD = '03' 
                                THEN SUM(1) 
                                ELSE 0 
                           END AS BF_03_CNT
                         , CASE WHEN B.VOC_CASE_CD = '04' 
                                THEN SUM(1) 
                                ELSE 0 
                           END AS NOW_04_CNT
                         , CASE WHEN C.VOC_CASE_CD = '04' 
                                THEN SUM(1) 
                                ELSE 0 
                           END AS BF_04_CNT
                      FROM (
                            SELECT LEV1.PROC_ST_DAY AS "LEV1_CUSTOM_CD"
                                 , LEV1.PROC_DAY_NM AS "LEV1_CUSTOM_NM"
                                 , LEV1.PROC_ST_DAY
                                 , LEV1.PROC_ED_DAY
                              FROM (
                                    SELECT 1 AS PROC_ST_DAY, 2 AS PROC_ED_DAY, '1일 이내' AS PROC_DAY_NM UNION ALL
                                    SELECT 2 AS PROC_ST_DAY, 4 AS PROC_ED_DAY, '2일 ~ 3일' AS PROC_DAY_NM UNION ALL
                                    SELECT 4 AS PROC_ST_DAY, 8 AS PROC_ED_DAY, '4일 ~ 7일' AS PROC_DAY_NM UNION ALL
                                    SELECT 8 AS PROC_ST_DAY, 15 AS PROC_ED_DAY, '8일 ~ 15일' AS PROC_DAY_NM UNION ALL
                                    SELECT 16 AS PROC_ST_DAY, 30 AS PROC_ED_DAY, '16일 ~ 30일' AS PROC_DAY_NM UNION ALL 
                                    SELECT 31 AS PROC_ST_DAY, 999 AS PROC_ED_DAY, '31일 이상' AS PROC_DAY_NM 
                                    ) LEV1
                            WHERE 1=1
                            ORDER BY LEV1.PROC_ST_DAY ASC
                            ) A 
                            LEFT OUTER JOIN (
                                                SELECT DATEDIFF(VOC_ACT_DT, REG_DT) AS ACT_DD
                                                     , VOC_CASE_CD 
                                                     , 1 AS CNT
                                                  FROM TB_VOC_MST
                                                 WHERE 1=1
                                                   AND DEL_YN = 'N'  
                                                   AND VOC_ACT_DT IS NOT NULL       /* 처리시간이 있는것 */
                                                   AND VOC_STATUS_CD = 'C0'         /* C0:처리완료 */
                                                   AND COMPANY_CD = #{companyCd}
                                                   AND REG_DT <![CDATA[ > ]]> ADDDATE(#{regDtStart}, -1)
                                                   AND REG_DT <![CDATA[ < ]]> ADDDATE(#{regDtEnd}, 1)
                                                <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(rcptChnnCd)">
                                                    AND RCPT_CHNN_CD = #{rcptChnnCd}
                                                </if>
                                                <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd1)">
                                                    AND VOC_TYPE_CD1 = #{vocTypeCd1}
                                                </if>
                                                <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd2)">
                                                    AND VOC_TYPE_CD2 = #{vocTypeCd2}
                                                </if>
                                                <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd3)">
                                                    AND VOC_TYPE_CD3 = #{vocTypeCd3}
                                                </if>               
                                                <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocActTypeCd1)">
					                                AND VOC_ACT_TYPE_CD1 = #{vocActTypeCd1} 
					                            </if>
					                            <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocActTypeCd2)">
					                                AND VOC_ACT_TYPE_CD2 = #{vocActTypeCd2} 
					                            </if>
                                            ) B
										   ON B.ACT_DD <![CDATA[ >= ]]>  A.PROC_ST_DAY
                                          AND B.ACT_DD <![CDATA[ < ]]> A.PROC_ED_DAY
                                          
                            LEFT OUTER JOIN (
                                                SELECT DATEDIFF(VOC_ACT_DT, REG_DT) AS ACT_DD
                                                     , VOC_CASE_CD
                                                     , 1 AS CNT
                                                  FROM TB_VOC_MST
                                                 WHERE 1=1
                                                   AND DEL_YN = 'N'  
                                                   AND VOC_ACT_DT IS NOT NULL       /* 처리시간이 있는것 */
                                                   AND VOC_STATUS_CD = 'C0'         /* C0:처리완료 */
                                                   AND COMPANY_CD = #{companyCd}
                                                   AND REG_DT <![CDATA[ > ]]> ADDDATE(date_add(#{regDtStart}, interval -1 YEAR), -1)
                                                   AND REG_DT <![CDATA[ < ]]> ADDDATE(date_add(#{regDtEnd}, interval -1 YEAR), 1)
                                                <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(rcptChnnCd)">
                                                    AND RCPT_CHNN_CD = #{rcptChnnCd}
                                                </if>
                                                <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd1)">
                                                    AND VOC_TYPE_CD1 = #{vocTypeCd1}
                                                </if>
                                                <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd2)">
                                                    AND VOC_TYPE_CD2 = #{vocTypeCd2}
                                                </if>
                                                <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocTypeCd3)">
                                                    AND VOC_TYPE_CD3 = #{vocTypeCd3}
                                                </if>                     
                                                <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocActTypeCd1)">
					                                AND VOC_ACT_TYPE_CD1 = #{vocActTypeCd1} 
					                            </if>
					                            <if test="@org.apache.commons.lang3.ObjectUtils@isNotEmpty(vocActTypeCd2)">
					                                AND VOC_ACT_TYPE_CD2 = #{vocActTypeCd2} 
					                            </if>
                                            ) C
										   ON C.ACT_DD <![CDATA[ >= ]]> A.PROC_ST_DAY
                                          AND C.ACT_DD <![CDATA[ < ]]> A.PROC_ED_DAY
                        GROUP BY A.LEV1_CUSTOM_CD
                               , A.LEV1_CUSTOM_NM
                    ) A
    </select>

</mapper>
